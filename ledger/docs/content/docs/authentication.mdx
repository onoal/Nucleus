---
title: Authentication
description: Secure your ledger API with authentication middleware
---

# Authentication

The Ledger Framework supports optional authentication middleware for securing your API endpoints.

## Overview

The authentication middleware supports multiple token types:

- **Connect Tokens**: DPoP-bound tokens with grant_id (for app-to-ledger communication)
- **Session Tokens**: OIDC access tokens (for user-to-ledger communication)
- **Dev Tokens**: Development tokens (format: `dev:oid:...`)
- **API Keys**: Legacy API key support

## Setup

```typescript
import {
  createLedgerServer,
  createAuthMiddleware,
} from "@onoal/ledger-core/server";

const server = createLedgerServer(ledger, {
  auth: {
    verifyConnectToken: async (token, env) => {
      // Verify Connect token
      // Should return payload with grant_id, actor, sub
      return await verifyConnectToken(token, env);
    },
    verifySessionToken: async (token, env) => {
      // Verify Session token (OIDC)
      // Should return payload with sub (subject)
      return await verifySessionToken(token, env);
    },
    verifyDpop: async (dpopProof, connectPayload, htm, htu) => {
      // Verify DPoP proof for Connect tokens
      // htm = HTTP method, htu = HTTP URI
      return await verifyDpop(dpopProof, connectPayload, htm, htu);
    },
    verifyConnectGrant: async (grantId, appOid, env) => {
      // Verify Connect grant exists and is active
      return await verifyConnectGrant(grantId, appOid, env);
    },
    publicPaths: [
      "/health",
      "/ledger/hash-root",
      "/ledger/verify",
      "/ledger/stats",
      "/.well-known/jwks.json",
    ],
    env: {
      LEDGER_API_KEY: process.env.LEDGER_API_KEY,
    },
  },
});
```

## Request Context

The authentication middleware extracts request context and makes it available to route handlers:

```typescript
// Route handler receives requester_oid via params
{
  method: "GET",
  path: "/ledger/proof/:id",
  handler: async (req, ledger, params) => {
    const requester_oid = params._requester_oid; // From auth middleware
    const requestContext = params._request_context; // Full context

    // Use requester_oid for ACL checks
    const proof = await proofService.getProof(id, requester_oid);
    // ...
  },
}
```

## Request Context Structure

```typescript
interface RequestContext {
  oid: string; // Requester OID
  role?: string; // Optional role
  token: string; // Original token
  claims: Record<string, unknown>; // Token claims
  source:
    | "connect_token"
    | "session_token"
    | "service_token"
    | "dev_token"
    | "api_key";
}
```

## Public Paths

Paths in `publicPaths` don't require authentication:

```typescript
const authMiddleware = createAuthMiddleware({
  publicPaths: ["/health", "/ledger/stats", "/.well-known/jwks.json"],
});
```

Paths starting with `/.well-known/` (except `/.well-known/secure`) are automatically public.

## Dev Tokens

For development, you can use dev tokens:

```bash
# Format: dev:oid:onoal:user:123
curl -H "Authorization: Bearer dev:oid:onoal:user:alice" \
  http://localhost:3000/ledger/proofs
```

Optional headers:

- `x-ledger-role`: Set role (default: "dev")
- `x-ledger-principal`: Override principal OID

## API Keys

Legacy API key support (requires `LEDGER_API_KEY` env var):

```bash
curl -H "Authorization: Bearer ${LEDGER_API_KEY}" \
  -H "x-ledger-principal: oid:onoal:org:my-org" \
  http://localhost:3000/ledger/proofs
```

## Integration with ACL

The authentication middleware works seamlessly with UAL/ACL:

```typescript
// Route handler
handler: async (req, ledger, params) => {
  const requester_oid = params._requester_oid;

  // Service automatically uses requester_oid for ACL checks
  const result = await proofService.queryProofs({
    requester_oid, // Passed to UAL.list() for ACL filtering
    subject_oid: "oid:onoal:user:alice",
  });
};
```

## Examples

### Cloudflare Worker with Auth

```typescript
import { createLedgerServer } from "@onoal/ledger-core/server";

export default {
  async fetch(request: Request, env: Env): Promise<Response> {
    const ledger = await createLedger({
      /* ... */
    });
    const server = createLedgerServer(ledger, {
      auth: {
        verifyConnectToken: async (token, env) => {
          // Your Connect token verification logic
        },
        verifySessionToken: async (token, env) => {
          // Your Session token verification logic
        },
        env,
      },
    });

    return server.handleRequest(request, env);
  },
};
```

### Express with Auth

```typescript
import express from "express";
import { createLedgerServer } from "@onoal/ledger-core/server";

const app = express();
const server = createLedgerServer(ledger, {
  auth: {
    /* ... */
  },
});

app.all("*", async (req, res) => {
  const response = await server.handleRequest(
    new Request(req.url, {
      method: req.method,
      headers: req.headers as HeadersInit,
      body: req.method !== "GET" ? JSON.stringify(req.body) : undefined,
    }),
    process.env
  );

  const data = await response.json();
  res.status(response.status).json(data);
});
```

## Next Steps

- [API Server](/docs/api-server) - Learn about the API server
- [Core Concepts](/docs/core-concepts) - Understand UAL/ACL integration
- [Modules](/docs/modules) - Explore module routes
